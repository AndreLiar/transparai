name: Dependency Update Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggers

jobs:
  check-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check Backend dependencies
        working-directory: ./Backend
        run: |
          echo "## ðŸ“¦ Backend Dependencies" >> ../dependency-report.md
          echo "### Outdated packages:" >> ../dependency-report.md
          npm outdated --long >> ../dependency-report.md || echo "No outdated packages" >> ../dependency-report.md
          echo "" >> ../dependency-report.md

      - name: Check Frontend dependencies
        working-directory: ./frontend
        run: |
          echo "## ðŸŽ¨ Frontend Dependencies" >> ../dependency-report.md
          echo "### Outdated packages:" >> ../dependency-report.md
          npm outdated --long >> ../dependency-report.md || echo "No outdated packages" >> ../dependency-report.md
          echo "" >> ../dependency-report.md

      - name: Check for security vulnerabilities
        run: |
          echo "## ðŸ”’ Security Audit" >> dependency-report.md
          echo "### Backend vulnerabilities:" >> dependency-report.md
          cd Backend && npm audit --audit-level=moderate >> ../dependency-report.md || echo "No vulnerabilities found" >> ../dependency-report.md
          echo "" >> dependency-report.md
          echo "### Frontend vulnerabilities:" >> dependency-report.md
          cd ../frontend && npm audit --audit-level=moderate >> ../dependency-report.md || echo "No vulnerabilities found" >> ../dependency-report.md

      - name: Create issue if updates needed
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.md', 'utf8');
            
            // Check if there are any updates needed
            if (report.includes('outdated') || report.includes('vulnerabilities')) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”„ Weekly Dependency Update - ${new Date().toISOString().split('T')[0]}`,
                body: `# Dependency Update Report\n\n${report}\n\n---\n\n**Action Required:** Please review and update dependencies as needed.\n\nGenerated automatically by GitHub Actions.`,
                labels: ['dependencies', 'maintenance']
              });
            }